<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Idle Clicker Pro</title>
  <style>
    :root{
      --radius: 16px;
      --bg1:#0b1020;
      --bg2:#0b1d2d;
      --text:#e9eefc;
      --muted:#a8b3d6;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --common:#94a3b8;
      --rare:#38bdf8;
      --epic:#c084fc;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 10px 24px rgba(0,0,0,.28);
    }

    *{ box-sizing:border-box; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      max-width: 980px;
      margin: 34px auto;
      padding: 0 16px;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 700px at 60% 90%, rgba(34,197,94,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin: 12px 0;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }

    .row{ display:flex; gap: 12px; flex-wrap: wrap; align-items:center; }
    .big{ font-size: 22px; font-weight: 950; }
    .muted{ color: var(--muted); }
    .small{ font-size: 13px; }

    .chip{
      display:inline-flex; align-items:center; gap: 8px; padding: 6px 10px;
      border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04); font-weight: 800; color: var(--text);
    }
    .dot{ width: 8px; height: 8px; border-radius: 99px; background: var(--accent2); box-shadow: 0 0 16px rgba(34,197,94,.45); }
    .dot.blue{ background: #38bdf8; box-shadow: 0 0 16px rgba(56,189,248,.45); }

    button{
      padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,.14);
      cursor: pointer; background: rgba(255,255,255,.06); color: var(--text);
      font-weight: 850; transition: transform .08s ease, background .15s ease;
    }
    button:hover:not(:disabled){ background: rgba(255,255,255,0.1); }
    button:active:not(:disabled){ transform: translateY(1px) scale(.98); }
    button:disabled{ opacity: .4; cursor: not-allowed; }

    .btnPrimary{ background: linear-gradient(180deg, rgba(124,58,237,.9), rgba(124,58,237,.65)); }
    .btnGood{ background: linear-gradient(180deg, rgba(34,197,94,.9), rgba(34,197,94,.65)); }
    .btnWarn{ background: linear-gradient(180deg, rgba(245,158,11,.9), rgba(245,158,11,.62)); }
    .btnDanger{ background: linear-gradient(180deg, rgba(239,68,68,.9), rgba(239,68,68,.62)); }

    .shopGrid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-top: 12px; }
    .item{
      border: 1px solid var(--border); border-radius: var(--radius); padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      display: flex; flex-direction: column; gap: 8px;
    }

    .pill{ border: 1px solid rgba(255,255,255,.14); border-radius: 999px; padding: 8px 12px; background: rgba(255,255,255,.06); }
    .pill.active{ border-color: var(--rare); background: rgba(56,189,248,.15); }

    .progressBar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.08); overflow:hidden; margin: 10px 0; }
    .progressFill{ height:100%; width:0%; background: linear-gradient(90deg, var(--rare), var(--accent)); transition: width 0.3s ease; }

    .pop{ position:absolute; pointer-events:none; font-weight: 950; animation: popAnim 0.7s ease-out forwards; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    @keyframes popAnim{ 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

    .questChoice{ border: 1px solid var(--border); padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); }
    .tagCommon{ color: var(--common); } .tagRare{ color: var(--rare); } .tagEpic{ color: var(--epic); }
  </style>
</head>
<body>

<div class="card">
  <div class="big">Kolikot: <span id="coins">0</span></div>
  <div class="row" style="margin-top:8px">
    <span class="chip"><span class="dot"></span> Per klikki: <span id="perClick">1</span></span>
    <span class="chip"><span class="dot blue"></span> Per sekunti: <span id="perSec">0</span></span>
  </div>
</div>

<div class="card row" style="position:relative;">
  <button id="clickBtn" class="btnGood" style="padding: 16px 32px;">Klikkaa +<span id="clickGain">1</span></button>
  <button id="buyClickBtn" class="btnPrimary">Päivitä Klikkaus (hinta <span id="clickCost">25</span>)</button>
  <div class="muted small">Tasot: <span id="clickUps">0</span></div>
  <div id="popContainer" style="position:absolute; top:0; left:50px; pointer-events:none;"></div>
</div>

<div class="card">
  <div class="row" style="justify-content: space-between;">
    <div class="big">Questi</div>
    <div id="questCooldown" class="muted small"></div>
  </div>
  <div id="questText" class="muted">-</div>
  <div class="progressBar"><div class="progressFill" id="questFill"></div></div>
  <div id="questHint" class="muted small">-</div>
  <div id="questChoicesWrap" class="shopGrid"></div>
  <button id="claimQuestBtn" class="btnWarn" style="margin-top:10px" disabled>Lunasta Palkinto</button>
</div>

<div class="card">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="big">Kauppa</div>
      <div class="muted small">Avaa uusia tier-tasoja ostamalla 10 edellistä.</div>
    </div>
    <div class="row">
      <button class="pill active" id="buyMode1">x1</button>
      <button class="pill" id="buyMode10">x10</button>
    </div>
  </div>
  <div id="tierBox" class="card" style="background: rgba(245,158,11,0.05); border-color: rgba(245,158,11,0.3); display:none;">
    <div class="row" style="justify-content: space-between;">
      <div>
        <div id="tierUnlockTitle" style="font-weight:900">Uusi Rakennus!</div>
        <div id="tierUnlockHint" class="small muted"></div>
      </div>
      <button id="buyTierBtn" class="btnWarn">Avaa (<span id="tierUnlockCost">0</span>)</button>
    </div>
  </div>
  <div id="shopGrid" class="shopGrid"></div>
</div>

<div class="card">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="big">Prestige: <span id="prestigePts">0</span> pts</div>
      <div class="muted small">Kerroin: x<span id="prestigeMult">1.00</span></div>
    </div>
    <button id="prestigeBtn" class="btnPrimary">Prestige (saat <span id="prestigeGain">0</span>)</button>
  </div>
</div>

<div class="row" style="justify-content: center; margin-top: 20px;">
  <button id="saveBtn">Save</button>
  <button id="resetBtn" class="btnDanger">Reset</button>
</div>

<script>
(() => {
  "use strict";

  // --- MUUTTUJAT ---
  let coins = 0;
  let perClick = 1;
  let clickUpgradeCost = 25;
  let prestigePoints = 0;
  let totalClicks = 0;
  let lifetimeEarned = 0;
  let buyMode = 1;
  let manualUnlocked = {};
  
  let buildings = [
    { id: "b1", name: "Klikkeri", baseCost: 15, baseCps: 1, owned: 0 },
    { id: "b2", name: "Työpaja", baseCost: 120, baseCps: 8, owned: 0 },
    { id: "b3", name: "Tehdas", baseCost: 1400, baseCps: 45, owned: 0 },
    { id: "b4", name: "Voimala", baseCost: 18000, baseCps: 200, owned: 0 },
    { id: "b5", name: "Pörssi", baseCost: 200000, baseCps: 1200, owned: 0 }
  ];

  let questState = { active: null, choices: null, readyAt: 0 };
  const SAVE_KEY = "idle_pro_v2_smooth";

  // --- APU ---
  const fmt = n => n >= 1000000 ? (n/1000000).toFixed(2) + "M" : n >= 1000 ? (n/1000).toFixed(1) + "k" : Math.floor(n);
  const getMult = () => 1 + (prestigePoints * 0.05);
  const getCps = () => buildings.reduce((s, b) => s + (b.owned * b.baseCps), 0);
  const costOfN = (b, n) => Math.ceil(b.baseCost * Math.pow(1.15, b.owned) * (Math.pow(1.15, n) - 1) / (1.15 - 1));

  function isUnlocked(idx) {
    if (idx === 0) return true;
    if (manualUnlocked[buildings[idx].id]) return true;
    return buildings[idx-1].owned >= 10;
  }

  // --- KAUPAN ALUSTUS (Estää säkenöinnin) ---
  const initShop = () => {
    const grid = document.getElementById("shopGrid");
    grid.innerHTML = "";
    buildings.forEach(b => {
      const div = document.createElement("div");
      div.className = "item";
      div.id = `shop-item-${b.id}`;
      div.style.display = "none";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <b id="name-${b.id}">${b.name}</b>
          <span id="owned-${b.id}" class="chip">0</span>
        </div>
        <div class="muted small" id="info-${b.id}">+0/s</div>
        <button id="btn-buy-${b.id}" onclick="window.gameBuy('${b.id}')">Osta</button>
      `;
      grid.appendChild(div);
    });
  };

  // --- PÄIVITYS ---
  function updateUI() {
    const mult = getMult();
    document.getElementById("coins").textContent = fmt(coins);
    document.getElementById("perClick").textContent = fmt(perClick * mult);
    document.getElementById("perSec").textContent = fmt(getCps() * mult);
    document.getElementById("clickGain").textContent = fmt(perClick * mult);
    document.getElementById("clickCost").textContent = fmt(clickUpgradeCost);
    document.getElementById("clickUps").textContent = perClick - 1;
    document.getElementById("prestigePts").textContent = prestigePoints;
    document.getElementById("prestigeMult").textContent = mult.toFixed(2);
    document.getElementById("prestigeGain").textContent = Math.floor(Math.sqrt(lifetimeEarned / 10000));

    // Kauppa - Älykäs päivitys
    buildings.forEach((b, idx) => {
      const el = document.getElementById(`shop-item-${b.id}`);
      if (isUnlocked(idx)) {
        el.style.display = "flex";
        const cost = costOfN(b, buyMode);
        document.getElementById(`owned-${b.id}`).textContent = b.owned;
        document.getElementById(`info-${b.id}`).textContent = `+${fmt(b.baseCps * mult)}/s`;
        const btn = document.getElementById(`btn-buy-${b.id}`);
        btn.textContent = `Osta x${buyMode} (${fmt(cost)})`;
        btn.disabled = coins < cost;
      } else {
        el.style.display = "none";
      }
    });

    // Tier Unlock
    const nextIdx = buildings.findIndex((_, i) => !isUnlocked(i));
    const tBox = document.getElementById("tierBox");
    if (nextIdx !== -1 && nextIdx > 0) {
      tBox.style.display = "block";
      const cost = buildings[nextIdx].baseCost * 3;
      document.getElementById("tierUnlockHint").textContent = `Tai osta 10 kpl: ${buildings[nextIdx-1].name}`;
      document.getElementById("tierUnlockCost").textContent = fmt(cost);
      document.getElementById("buyTierBtn").disabled = coins < cost;
      document.getElementById("buyTierBtn").onclick = () => {
        if (coins >= cost) { coins -= cost; manualUnlocked[buildings[nextIdx].id] = true; updateUI(); }
      };
    } else { tBox.style.display = "none"; }

    updateQuestUI();
  }

  function updateQuestUI() {
    const qWrap = document.getElementById("questChoicesWrap");
    if (questState.active) {
      qWrap.style.display = "none";
      const q = questState.active;
      let prog = q.type === "click" ? (totalClicks - q.baseline) : (lifetimeEarned - q.baseline);
      let perc = Math.min(100, (prog / q.target) * 100);
      document.getElementById("questText").textContent = q.title;
      document.getElementById("questFill").style.width = perc + "%";
      document.getElementById("questHint").textContent = `${fmt(prog)} / ${fmt(q.target)}`;
      document.getElementById("claimQuestBtn").disabled = prog < q.target;
      document.getElementById("claimQuestBtn").style.display = "block";
    } else {
      document.getElementById("claimQuestBtn").style.display = "none";
      if (Date.now() < questState.readyAt) {
        qWrap.style.display = "none";
        document.getElementById("questText").textContent = "Uudet tehtävät valmistuvat...";
        document.getElementById("questCooldown").textContent = Math.ceil((questState.readyAt - Date.now())/1000) + "s";
        document.getElementById("questFill").style.width = "0%";
      } else {
        qWrap.style.display = "grid";
        document.getElementById("questText").textContent = "Valitse haaste:";
        if (!questState.choices) generateQuests();
        renderQuestChoices();
      }
    }
  }

  function generateQuests() {
    const cps = Math.max(1, getCps());
    questState.choices = [
      { id: 1, title: `Klikkaa 50 kertaa`, type: "click", target: 50, reward: cps * 150, rarity: "Common" },
      { id: 2, title: `Kerää ${fmt(cps*300)} kolikkoa`, type: "earn", target: cps*300, reward: cps * 500, rarity: "Rare" }
    ];
  }

  function renderQuestChoices() {
    const wrap = document.getElementById("questChoicesWrap");
    wrap.innerHTML = "";
    questState.choices.forEach(c => {
      const d = document.createElement("div");
      d.className = "questChoice";
      d.innerHTML = `<div class="tag${c.rarity}" style="font-weight:900">${c.rarity}</div><div class="small">${c.title}</div><button onclick="window.startQuest(${c.id})" style="margin-top:8px; padding:4px 8px; font-size:11px">Valitse</button>`;
      wrap.appendChild(d);
    });
  }

  // --- TOIMINNOT ---
  window.gameBuy = (id) => {
    const b = buildings.find(x => x.id === id);
    const cost = costOfN(b, buyMode);
    if (coins >= cost) { coins -= cost; b.owned += buyMode; updateUI(); }
  };

  window.startQuest = (id) => {
    questState.active = questState.choices.find(c => c.id === id);
    questState.active.baseline = questState.active.type === "click" ? totalClicks : lifetimeEarned;
    updateUI();
  };

  document.getElementById("clickBtn").onclick = (e) => {
    const gain = perClick * getMult();
    coins += gain; lifetimeEarned += gain; totalClicks++;
    
    const pop = document.createElement("div");
    pop.className = "pop"; pop.textContent = "+" + fmt(gain);
    pop.style.left = e.clientX + "px"; pop.style.top = e.clientY + "px";
    pop.style.color = "var(--accent2)";
    document.body.appendChild(pop);
    setTimeout(() => pop.remove(), 700);
    updateUI();
  };

  document.getElementById("buyClickBtn").onclick = () => {
    if (coins >= clickUpgradeCost) {
      coins -= clickUpgradeCost; perClick++;
      clickUpgradeCost = Math.ceil(clickUpgradeCost * 1.6);
      updateUI();
    }
  };

  document.getElementById("claimQuestBtn").onclick = () => {
    coins += questState.active.reward;
    questState.active = null; questState.choices = null;
    questState.readyAt = Date.now() + 15000;
    updateUI();
  };

  document.getElementById("buyMode1").onclick = () => { buyMode = 1; updatePills(); };
  document.getElementById("buyMode10").onclick = () => { buyMode = 10; updatePills(); };
  function updatePills() {
    document.getElementById("buyMode1").classList.toggle("active", buyMode === 1);
    document.getElementById("buyMode10").classList.toggle("active", buyMode === 10);
    updateUI();
  }

  document.getElementById("prestigeBtn").onclick = () => {
    const gain = Math.floor(Math.sqrt(lifetimeEarned / 10000));
    if (gain < 1) return alert("Tarvitset enemmän tuloja (10k+) prestigeen!");
    if (confirm("Prestige nollaa etenemisen, mutta saat pysyvän bonuksen. Jatka?")) {
      prestigePoints += gain; coins = 0; lifetimeEarned = 0;
      buildings.forEach(b => b.owned = 0);
      perClick = 1; clickUpgradeCost = 25; manualUnlocked = {};
      save(); location.reload();
    }
  };

  function save() {
    localStorage.setItem(SAVE_KEY, JSON.stringify({ coins, perClick, clickUpgradeCost, prestigePoints, buildings, manualUnlocked, lifetimeEarned, totalClicks }));
  }
  function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if (s) {
      const d = JSON.parse(s);
      coins = d.coins; perClick = d.perClick; clickUpgradeCost = d.clickUpgradeCost;
      prestigePoints = d.prestigePoints; buildings = d.buildings; manualUnlocked = d.manualUnlocked || {};
      lifetimeEarned = d.lifetimeEarned; totalClicks = d.totalClicks;
    }
  }

  document.getElementById("saveBtn").onclick = save;
  document.getElementById("resetBtn").onclick = () => { if(confirm("Nollaa kaikki?")) { localStorage.clear(); location.reload(); }};

  initShop();
  load();
  setInterval(() => {
    const sGain = (getCps() * getMult()) / 10;
    coins += sGain; lifetimeEarned += sGain;
  }, 100);
  setInterval(updateUI, 200); // UI päivittyy 5 kertaa sekunnissa - ei välky, mutta tuntuu nopealta.

})();
</script>
</body>
</html>
