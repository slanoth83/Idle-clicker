// --- JATKUU EDELLISEST√Ñ ---

  let lastChoicesKey = ""; // Apumuuttuja est√§m√§√§n turha DOM-p√§ivitys

  function updateUI() {
    const mult = getPrestigeMultiplier();
    const curCps = calcPerSecond() * mult;

    elCoins.textContent = fmt(coins);
    elPerClick.textContent = fmt(perClick * mult);
    elPerSec.textContent = fmt(curCps);
    elClickGain.textContent = fmt(perClick * mult);
    elClickCost.textContent = fmt(clickUpgradeCost);
    elClickUps.textContent = clickUpgrades;

    elPrestigePts.textContent = fmt(prestigePoints);
    elPrestigeMult.textContent = mult.toFixed(2);
    elPrestigeGain.textContent = fmt(calcPrestigeGain());

    // Milestonen p√§ivitys
    const ms = getMilestone();
    elMilestoneText.textContent = ms.text;
    elMilestoneFill.style.width = (Math.min(1, ms.cur / ms.goal) * 100) + "%";
    elMilestoneHint.textContent = ms.hint;

    // Achievementit
    const achList = Object.entries(achievements)
      .filter(([_, earned]) => earned)
      .map(([key]) => key === "firstGenerator" ? "üèóÔ∏è" : key === "tenTotalBuildings" ? "üè¢" : key === "hundredClicks" ? "üñ±Ô∏è" : "üëë")
      .join(" ");
    elAchText.textContent = achList || "Ei viel√§ saavutuksia.";

    // Tier Unlock
    const tInfo = getTierUnlockInfo();
    const elTierBox = document.getElementById("tierBox");
    if (tInfo.done) {
      elTierBox.style.display = "none";
    } else {
      elTierBox.style.display = "flex";
      document.getElementById("tierUnlockTitle").textContent = `Avaa: ${tInfo.nextName}`;
      document.getElementById("tierUnlockHint").textContent = `Tarvitset 10 kpl kohdetta ${tInfo.prevName} (nyt ${tInfo.owned}/10)`;
      document.getElementById("tierUnlockCost").textContent = fmt(tInfo.cost);
      document.getElementById("buyTierBtn").disabled = coins < tInfo.cost;
    }

    // Kaupan kohteet
    updateShop();

    // Quest-osio
    updateQuestUI();
  }

  function updateShop() {
    shopGrid.innerHTML = "";
    buildings.forEach((b, idx) => {
      if (!isUnlockedIndex(idx)) return;

      const cost = buyMode === "max" ? costOfNext(b) : (buyMode === "x10" ? costForN(b, 10) : (buyMode === "x25" ? costForN(b, 25) : costOfNext(b)));
      const canAfford = coins >= cost;

      const item = document.createElement("div");
      item.className = "item fadeInUp";
      item.innerHTML = `
        <div class="itemTop">
          <span class="itemName">${b.name} (x${b.owned})</span>
          <span class="muted small">${fmt(b.baseCps)}/s kpl</span>
        </div>
        <div class="row">
          <button onclick="window.game.buyBuilding('${b.id}')" ${!canAfford ? 'disabled' : ''}>
            Osta ${buyMode} (hinta ${fmt(cost)})
          </button>
        </div>
      `;
      shopGrid.appendChild(item);
    });
  }

  function updateQuestUI() {
    const q = questState.active;
    const cd = cooldownLeft();

    if (q) {
      const prog = activeQuestProgress(q);
      const perc = Math.min(1, prog / q.target);
      elQuestText.textContent = q.title;
      elQuestFill.style.width = (perc * 100) + "%";
      elQuestHint.textContent = `${fmt(prog)} / ${fmt(q.target)}`;
      document.getElementById("claimQuestBtn").disabled = !canClaimActiveQuest();
      document.getElementById("questChoicesWrap").innerHTML = "";
    } else if (cd > 0) {
      elQuestText.textContent = "Lepotauko...";
      elQuestFill.style.width = "0%";
      elQuestHint.textContent = "Seuraavat teht√§v√§t valmistuvat pian.";
      elQuestCooldown.textContent = fmtTime(cd);
      
      // Cooldown rengas
      const ring = document.getElementById("cooldownRing");
      const offset = 88 - (88 * (1 - cd / QUEST_COOLDOWN));
      ring.style.strokeDashoffset = offset;
      document.getElementById("nextQuestIn").textContent = fmtTime(cd);
    } else {
      renderQuestChoices();
    }
  }

  function renderQuestChoices() {
    if (!questState.choices) return;
    const key = questState.choices.map(c => c.id).join("");
    if (key === lastChoicesKey) return;
    lastChoicesKey = key;

    const wrap = document.getElementById("questChoicesWrap");
    wrap.innerHTML = "";
    questState.choices.forEach(c => {
      const div = document.createElement("div");
      div.className = "questChoice fadeInUp";
      div.innerHTML = `
        <div class="questMeta">
          <span class="questTag tag${c.rarity}">${c.rarity}</span>
          <span class="small muted">Palkinto: ${fmt(c.rewardCoins)} kolikkoa</span>
        </div>
        <div class="questTitle">${c.title}</div>
        <button class="btnPrimary small" onclick="window.game.chooseQuest('${c.id}')">Valitse</button>
      `;
      wrap.appendChild(div);
    });
  }

  // --- PELIN TOIMINNOT (Globaalit window-oliolle) ---
  window.game = {
    buyBuilding: (id) => {
      const b = buildings.find(x => x.id === id);
      let count = buyMode === "x10" ? 10 : (buyMode === "x25" ? 25 : 1);
      if (buyMode === "max") { smartMaxBuy(); return; }
      
      const cost = costForN(b, count);
      if (spendCoins(cost)) {
        b.owned += count;
        SFX.buy();
      }
    },
    chooseQuest: (id) => chooseQuest(id)
  };

  // --- TALLENNUS ---
  function save() {
    const data = {
      coins, perClick, clickUpgrades, prestigePoints,
      buildings, manualUnlocked, questState, totalClicks, lifetimeEarned, achievements
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  }

  function load() {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    try {
      const d = JSON.parse(raw);
      coins = d.coins || 0;
      perClick = d.perClick || 1;
      clickUpgrades = d.clickUpgrades || 0;
      prestigePoints = d.prestigePoints || 0;
      if (d.buildings) buildings = d.buildings;
      manualUnlocked = d.manualUnlocked || {};
      questState = d.questState || questState;
      totalClicks = d.totalClicks || 0;
      lifetimeEarned = d.lifetimeEarned || 0;
      achievements = d.achievements || achievements;
    } catch(e) { console.error("Latausvirhe", e); }
  }

  // --- SY√ñTTEET ---
  clickBtn.addEventListener("click", () => {
    const gain = perClick * getPrestigeMultiplier();
    addCoins(gain);
    totalClicks++;
    SFX.click();
    checkAchievements();
    
    // Pop-up efekti
    const p = document.createElement("div");
    p.className = "pop";
    p.textContent = `+${fmt(gain)}`;
    p.style.left = (Math.random() * 40 + 20) + "px";
    popContainer.appendChild(p);
    setTimeout(() => p.remove(), 700);
  });

  buyClickBtn.addEventListener("click", () => {
    if (spendCoins(clickUpgradeCost)) {
      clickUpgrades++;
      perClick += 1;
      clickUpgradeCost = Math.ceil(clickUpgradeCost * 1.5);
      SFX.buy();
    }
  });

  document.getElementById("buyTierBtn").addEventListener("click", buyNextTierUnlock);
  document.getElementById("claimQuestBtn").addEventListener("click", claimActiveQuest);
  document.getElementById("saveBtn").addEventListener("click", () => { save(); alert("Peli tallennettu!"); });
  document.getElementById("resetBtn").addEventListener("click", () => {
    if(confirm("Haluatko varmasti nollata kaiken?")) {
      localStorage.removeItem(SAVE_KEY);
      location.reload();
    }
  });

  // --- PRESTIGE ---
  prestigeBtn.addEventListener("click", () => {
    const gain = calcPrestigeGain();
    if (gain < 1) { alert("Tarvitset enemm√§n kolikoita prestigeen!"); return; }
    if (confirm(`Prestige nollaa kolikot ja rakennukset, mutta saat ${gain} pistett√§. Jatketaanko?`)) {
      prestigePoints += gain;
      coins = 0;
      buildings.forEach(b => b.owned = 0);
      manualUnlocked = {};
      clickUpgrades = 0;
      perClick = 1;
      clickUpgradeCost = 25;
      save();
      location.reload();
    }
  });

  // --- OSTO-MOODIT ---
  [buyMode1, buyMode10, buyMode25, buyModeMax].forEach(btn => {
    btn.addEventListener("click", () => {
      [buyMode1, buyMode10, buyMode25, buyModeMax].forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      buyMode = btn.id.replace("buyMode", "").toLowerCase();
      if (buyMode === "") buyMode = "x1"; // korjaus x1-napille
      updateUI();
    });
  });

  // --- PELISILMUKKA ---
  function tick() {
    const income = (calcPerSecond() * getPrestigeMultiplier()) / 10;
    addCoins(income);
    maybeEndCooldown();
    ensureQuestChoices();
  }

  load();
  setInterval(tick, 100); // 10 kertaa sekunnissa logiikka
  setInterval(updateUI, 200); // 5 kertaa sekunnissa UI
  setInterval(save, 30000); // Automaattitallennus 30s v√§lein

})();
</script>
</body>
</html>
